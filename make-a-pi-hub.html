<!DOCTYPE HTML>
<html>
  <head>
    <title>diyActive: Make a Raspberry Pi Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Step-by-step guide to build a Raspberry Pi 3 Bluetooth sniffer from scratch, with real-time kiosk-mode display.">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.13.4/ui-bootstrap-tpls.min.js"></script>
    <script type="text/javascript" src="js/diyactive.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-49659454-2', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body ng-app="diyActive">
    <div ng-controller="InteractionCtrl">
      <nav class="navbar navbar-default" role="navigation">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle"
                  ng-init="navCollapsed = true"
                  ng-click="navCollapsed = !navCollapsed">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://www.reelyactive.com">
            <strong>reely</strong>Active
          </a>
        </div>
        <div class="collapse navbar-collapse" ng-class="!navCollapsed && 'in'"
             ng-click="navCollapsed = true">
          <ul class="nav navbar-nav navbar-right">
            <li class="active"><a href="index.html"> diyActive </a></li>
            <li class="dropdown" dropdown on-toggle="toggled(open)">
              <a href class="dropdown-toggle" dropdown-toggle role="button"
                 data-toggle="dropdown" aria-haspopup="true"
                 aria-expanded="false">
                Quick links <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="https://github.com/reelyactive/" target="_blank">
                    reelyActive on GitHub
                  </a>
                </li>
                <li>
                  <a href="https://www.npmjs.com/~reelyactive" target="_blank">
                    reelyActive on npmjs
                  </a>
                </li>
                <li role="separator" class="divider"></li>
                <li>
                  <a href="http://www.hyperlocalcontext.com" target="_blank">
                    www.hyperlocalcontext.com
                  </a>
                </li>
                <li>
                  <a href="http://smartspac.es" target="_blank">
                    smartspac.es
                  </a>
                </li>
                <li role="separator" class="divider"></li>
                <li>
                  <a href="http://shop.reelyactive.com" target="_blank">
                    Our online store
                  </a>
                </li>
                <li>
                  <a href="http://www.reelyactive.com" target="_blank">
                    Our website
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <div class="container-fluid">
        <div class="row">
          <div class="col-xs-0 col-sm-1 col-md-2 col-lg-3"></div>
          <div class="col-xs-12 col-sm-10 col-md-8 col-lg-6">
            <h1> Make a Raspberry Pi hub </h1>
            <p> The Raspberry Pi 3 is the first in its family to natively support Bluetooth.  Since at <a href="http://www.reelyactive.com" target="_blank">reelyActive</a> we're passionate about <a href="http://www.reelyactive.com/advertise/" target="_blank">the endless possibilities of detecting "advertising" Bluetooth Low Energy (BLE) devices</a>, we were excited to make the Pi 3 into a sniffer using <a href="https://github.com/reelyactive/pi-suite" target="_blank">our open source code</a>.  In this tutorial we'll take you step-by-step through building a reliable, standalone BLE sniffer from a virgin Pi 3. </p>
            <div class="well">
              <div class="row">
                <div class="col-xs-12 col-sm-4">
                  <a href="http://hackaday.com/2016/08/01/sniffing-bluetooth-devices-with-a-raspberry-pi/">
                    <img src="images/hackaday-pi-ble.jpg"
                         class="img-responsive center-block">
                  </a>
                </div>
                <div class="col-xs-12 col-sm-8"> 
                  <h2> As presented on Hackaday </h2>
                  <p> At the Eleventh HOPE conference, we showed off a standalone Raspberry Pi 3 Bluetooth Low Energy (BLE) sniffer to the Hackaday crew, which they found cool enough to share with their readers. </p>
                  <p> You'll find instructions below to replicate the setup and more, making use of the integrated BLE radio.  Just add power and network and you have yourself a versatile sub-$100 tool/toy! </p>
                  <a class="btn btn-primary" href="http://hackaday.com/2016/08/01/sniffing-bluetooth-devices-with-a-raspberry-pi/"
                     role="button"> Read the Hackaday Post </a>
                </div>
              </div>
            </div>
            <h2> Hardware Prerequisites </h2>
            <p> You'll need a Raspberry Pi 3 (or equivalent) with native Bluetooth capability in order to make a standalone sniffer. </p>
            <p> If you have a non-Bluetooth Pi, do not despair!  You can connect a purpose-built reelyActive starter kit to your Pi via USB for even-better sniffage! </p>
            <img src="images/piHub-connected.jpg"
                 class="img-responsive center-block">
            <p> Both items can be purchased by following the links below.  If you prefer to get your hands dirty with the reelyActive kit, you can also <a href="build-your-own-hub.html#usb-hub" target="_blank">Build your own USB Hub</a> and purchase <a href="http://shop.reelyactive.com/products/ra-r436" target="_blank">the reelceiver</a>.
            </p>
            <p class="text-center">
              <a class="btn btn-primary" role="button"
                 href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">
                Buy a Pi 3 </a> &nbsp;
              <a class="btn btn-primary" role="button"
                 href="http://shop.reelyactive.com/products/starterkit-min">
                Buy a Starter Kit </a>
            </p>
            <h2> Preparing the Pi </h2>
            <p> Does your Pi already have an operating system (Raspbian/NOOBS) installed and is connected to the Internet? </p>
            <p class="text-center" ng-hide="showPrep">
              <button type="button" class="btn btn-default"
                      ng-click="showPrep = !showPrep">No, I need to do this!</button>
            </p>
            <tabset collapse="!showPrep">
              <tab heading="Jessie Lite (Recommended)">
                <p> This is our preferred setup for a lean, efficient Raspberry Pi!  <i>Every byte of memory counts!</i> </p>
                <h3> SD Card </h3>
                <p> Download the latest Raspbian Jessie Lite image from <a href="https://www.raspberrypi.org/downloads/raspbian/" target="_blank">www.raspberrypi.org/downloads/raspbian/</a>.  Then follow the instructions (<a href="https://www.raspberrypi.org/documentation/installation/installing-images/linux.md" target="_blank">Linux</a>, <a href="https://www.raspberrypi.org/documentation/installation/installing-images/mac.md" target="_blank">Mac</a> or <a href="https://www.raspberrypi.org/documentation/installation/installing-images/windows.md" target="_blank">Windows</a>) to transfer the image to an SD card of at least 4GB. </p>
                <h3> Basic settings </h3>
                <p> Enable SSH (it is disabled by default) by browsing to the root of the /boot folder of the SD card and running from the command line: </p>
                <pre>sudo touch ./ssh</pre>
                <p> Enable Ethernet static fallback so that you can directly connect the Pi to your PC and SSH in to a known IP address.  Browse to the root of the / folder of the SD card and, from the command line open the dhcpcd.conf file for editing: </p>
                <pre>sudo nano /etc/dhcpcd.conf</pre>
                <p> Paste the following lines at the bottom of the file and save: </p>
                <pre>
# Define static profile
profile static_eth0
static ip_address=10.0.50.100/24
static routers=10.0.50.1
static domain_name_servers=10.0.50.1

# Fallback to static profile on eth0
interface eth0
fallback static_eth0
                </pre>
                <p> This will configure the Pi to use IP address <b>10.0.50.100</b> when it is connected to Ethernet without DHCP. </p>
                <h3> First Connection </h3>
                <p> Complete the following in order: </p>
                <ol>
                  <li> insert the SD card in the Pi
                  <li> connect the Pi to your PC via a network cable
                  <li> apply power to the Pi
                  <li> configure your PC's Ethernet adapter to use an address in the same subnet as the Pi (ex: 10.0.50.101)
                </ol>
                <p> From the command line, ssh into the Pi as follows: </p>
                <pre>ssh pi@10.0.50.100</pre>
                <p> The default password will be <i>raspberry</i>. You're now connected to the Pi. </p>
                <h3> raspi-config </h3>
                <p> Configure the Pi by running the following from the command line: </p>
                <pre>sudo raspi-config</pre>
                <p> From the text-based menu, select the option to change the user password. Choose a password that cannot be easily guessed, but is nonetheless straightforward to enter from the command line next time you'll ssh in.  Select <i>Finish</i>, then select <i>Yes</i> when asked to reboot.</p>
                <p> SSH back into the Pi once the reboot is complete (using the new password).  <i>The Pi is ready!</i> </p>
              </tab>
              <tab heading="NOOBS">
                <p> Take this beginner-friendly route if you intend to run your Pi as a multi-purpose computer with mouse and keyboard attached. </p>
                <h3> SD Card </h3>
                <p> The Pi's filesystem resides on an SD card.  If your Pi came with a prepared SD card, lucky you, you get to skip this step! </p>
                <p> The <a href="https://www.raspberrypi.org/help/quick-start-guide/" target="_blank">Quick Start Guide</a> suggests an 8GB class 4 SD card, which we encourage you to purchase from an established vendor.  If the card doesn't come formatted as FAT32, you'll need to do so (read the INSTRUCTIONS-README.txt included in the NOOBS ZIP file). </p>
                <p> <a href="https://www.raspberrypi.org/downloads/" target="_blank">Download NOOBS</a> and unzip the contents to the root folder of the SD card.  You're all set! </p>
                <h3> Initial Boot </h3>
                <p> Connect the following to your Pi:
                  <ul>
                    <li> the prepared SD card in its slot
                    <li> a USB keyboard in one of the USB ports
                    <li> a USB mouse in another USB port
                    <li> a monitor via the HDMI port
                  </ul>
                </p>
                <p> Then power the Pi through a <u>high-quality</u> USB power source (ex: phone charger).  Follow the instructions on screen to install the Raspbian operating system.  This procedure will take some time.  Perhaps enjoy a slice or two of delicious raspberry pie while you wait? </p>
                <h3> Connect to Network </h3>
                <p> After Raspbian boots, connect the Pi to the Internet via either WiFi or Ethernet using the on-screen tools.  <i>The Pi is ready!</i> </p> 
              </tab>
            </tabset>
            <hr collapse="!showPrep">
            <h3> Update packages </h3>
            <p> It is good practice to ensure that the software on the Pi is up to date before proceeding with any software installation.  From the command line on the Pi, execute the following in order: </p>
            <pre> 
sudo apt-get update
sudo apt-get upgrade
            </pre>
            <h2> Install Node.js and forever </h2>
            <p> <a href="https://nodejs.org" target="_blank">Node.js</a> is a JavaScript runtime which runs libraries (such as our own) from the largest ecosystem of open source libraries in the world.  The <a href="https://www.npmjs.com/package/forever" target="_blank">forever</a> package is one of these libraries, and it will keep our programs running forever, even if they crash. </p>
            <h3> Install Node.js </h3>
            <p> Raspbian will likely include an old version of Node.js.  Here we'll provide the instructions for installing the latest LTS (long term support version) which will be required.  From the command line on the Pi, execute the following in order (optionally change 6.9.2 below throughout to the latest LTS version as indicated <a href="https://nodejs.org" target="_blank">here</a>): </p>
            <pre> 
cd ~/Downloads
wget https://nodejs.org/dist/v6.9.2/node-v6.9.2-linux-armv7l.tar.xz
tar -xf node-v6.9.2-linux-armv7l.tar.xz
sudo mv node-v6.9.2-linux-armv7l /usr/local/node
cd /usr/local/bin
sudo ln -s /usr/local/node/bin/node node
sudo ln -s /usr/local/node/bin/npm npm
            </pre>
            <p> Confirm that v6.9.2 appears when you run <code>node -v</code>.  Node.js is now installed. </p>
            <h3> Install forever </h3>
            <pre> 
cd /usr/local/bin
sudo npm install forever -g
sudo ln -s /usr/local/node/bin/forever forever
            </pre>
            <h2> Install pi-suite </h2>
            <p> The pi-suite is a collection of <a href="http://reelyactive.github.io/?tab=software" target="_blank">reelyActive open source software</a> which allows your Pi to: </p>
            <ul>
              <li> listen for BLE devices by itself (Raspberry Pi 3+)
              <li> listen for BLE devices via a reelyActive starter kit
              <li> interpret the packets of these BLE devices
              <li> host webpages displaying the interpreted data
              <li> display these webpages via HDMI
              <li> forward the live data stream to a remote server
            </ul>
            <p> If you're running <i>Jessie Lite</i>, you'll first need to install git by running &nbsp; <tt>sudo apt-get install git-core</tt> &nbsp; from the command line. </p>
            <p> From the command line on the Pi, execute the following in order: </p>
            <pre> 
mkdir ~/reelyActive
cd ~/reelyActive
git clone https://github.com/reelyactive/pi-suite.git
cd pi-suite
npm install
            </pre>
            <h2> Start Sniffing! </h2>
            <p> Choose your configuration below and get up and running in an instant. </p>
            <tabset>
              <tab heading="I have a Pi 3">
                <h3> Run pi-suite </h3>
                <p> From the command line on the Pi, where you should still be in the ~/reelyActive/pi-suite folder, execute the following: </p>
                <pre>sudo node pi-suite</pre>
                <p> The console output should include a line that says <b>Browse to your Pi at http://xxx.xxx.xxx.xxx</b> with the IP address of your Pi in place of the x values.  Copy the link and open it in your browser. </p>
                <img src="images/piHub-hlc-server.gif"
                     class="img-responsive center-block"><br>
                <p> Once you've finished your initial exploration of the various webpages displaying the live data, press Ctrl-C to terminate the execution of pi-suite before proceeding with the next steps. </p>
              </tab>
              <tab heading="I have a starter kit">
                <h3> Connect your starter kit </h3>
                <p> Connect your starter kit to any free USB port on the Pi taking care to respect the reelceiver directionality, as shown in the video. </p>
                <div class="embed-container"><iframe src="https://www.youtube.com/embed/bbwgdcXSs5M?rel=0&controls=0&showinfo=0&modestbranding" frameborder="0" allowfullscreen></iframe></div>
                <h3> Run pi-suite-pareto </h3>
                <p> From the command line on the Pi, where you should still be in the ~/reelyActive/pi-suite folder, execute the following: </p>
                <pre>sudo node pi-suite-pareto</pre>
                <h3> View the data in Pareto </h3>
                <p> Browse to <a href="https://pareto.reelyactive.com" target="_blank">pareto.reelyactive.com</a> and log in with the credentials provided when you purchased the starter kit. </p>
                <h3> View the data on your Pi </h3>
                <p> The console output should include a line that says <b>Browse to your Pi at http://xxx.xxx.xxx.xxx</b> with the IP address of your Pi in place of the x values.  Copy the link and open it in your browser. </p>
                <img src="images/piHub-hlc-server.gif"
                     class="img-responsive center-block"><br>
                <p> Once you've finished your initial exploration of the various webpages displaying the live data, press Ctrl-C to terminate the execution of pi-suite-pareto before proceeding with the next steps. </p>
              </tab>
              <tab heading="I have neither">
                <p> Unfortunately that means you have no Bluetooth Low Energy radio on which to listen, as indicated in the Hardware Prerequisites section.  May we suggest you purchase a <a href="http://shop.reelyactive.com/products/starterkit-min" target="_blank">starter kit</a>? </p>
              </tab>
            </tabset>
            <hr>
            <p> &nbsp; </p>
            <h2> Configure run-on-boot with kiosk display </h2>
            <p> In this final <u>OPTIONAL</u> step we'll configure the Pi to run pi-suite automatically on boot, as well as display its webpage on any monitor via the HDMI port. </p>
            <h3> Install kiosk display packages </h3>
            <p> In order for the Pi to display a webpage in kiosk mode, we'll need the iceweasel browser (which handles JavaScript much better than the default Epiphany browser) and a window manager.  From the command line, execute the following: </p>
            <pre> 
sudo apt install iceweasel
sudo apt-get install matchbox-window-manager xautomation unclutter
            </pre>
            <h4> Install Xorg (special case) </h4>
            <p> This step applies <u>only</u> if your Pi is running <i>Jessie Lite</i> which doesn't have a GUI pre-installed.  If you're already able to boot into a friendly desktop environment, <i> skip this step </i>.  From the command line, execute the following: </p>
            <pre> 
sudo apt-get install --no-install-recommends xserver-xorg
sudo apt-get install --no-install-recommends xinit
sudo apt-get install --no-install-recommends x11-xserver-utils
            </pre>
            <h3> Configure run-on-boot </h3>
            <p> Here we'll specify what programs to run on boot via the <a href="https://www.raspberrypi.org/documentation/linux/usage/rc-local.md" target="_blank">rc.local</a> file.  From the command line, open the file for editing with the command <code>sudo nano /etc/rc.local</code> and paste the following three lines <u>above</u> the <i>exit 0</i> line: </p>
            <pre> 
sudo forever start /home/pi/reelyActive/pi-suite/pi-suite.js
sleep 30; sudo xinit /home/pi/reelyActive/pi-suite/display-iceweasel &
sleep 30; xte "key F11" -x:0
            </pre>
            <p> Press Ctrl-X to save and exit the editor.  Note that if you're using the Pi as a hub for a <a href="https://shop.reelyactive.com/products/starterkit-min" target="_blank">reelyActive starter kit</a> that should forward the real-time data to <a href="https://getpareto.com" target="_blank">Pareto</a>, you'll need to change the first line to instead run <b>pi-suite-pareto.js</b>. </p>
            <h3> Configure console autologin </h3>
            <p> Now that the Pi is configured to run-on-boot with a kiosk display, there's no reason for it to load the desktop and waste valuable computing and memory resources.  Instead we'll configure the Pi to boot to the console and log in automatically.  From the command line, run <code>sudo raspi-config</code> and from the <i>Boot Options</i> menu, select <i>Console Autologin</i> (which may be under a Desktop/CLI sub-menu). </p>
            <h3> Reboot </h3>
            <p> Reboot the Pi with the command <code>sudo reboot</code> or with a power cycle.  Confirm that after a minute or so you can browse to the Pi and observe the webpage decoding BLE devices.  Also confirm that the webpage is projected on an HDMI-connected monitor (connect the monitor <i>before</i> the reboot so that the resolution can be detected). </p>
            <h2> Optional features </h2>
            <p> Consider implementing the following optional features. </p>
            <tabset>
              <tab heading="Scheduled reboots">
                <p> Scheduled reboots ensure that the Pi will eventually recover from any soft failure.  To force daily reboots via a cron job, from the command line, open the crontab file for editing with the command <code>sudo nano /etc/crontab</code> and paste the following line of code <u>above</u> the closing #. </p>
                <pre> 
0  5    * * *   root    reboot
                </pre> 
                <p> The 5 signifies 5am.  Adjust this and the other parameters as your application requires. </p>
              </tab>
              <tab heading="Ethernet fallback">
                <p> Ethernet fallback ensures that you can always directly connect to your Pi at a known static IP.  The Pi will assume the static IP on its Ethernet port in the absence of a DHCP server.  To enable Ethernet fallback, from the command line, open the dhcpcd.conf file for editing with the command <code>sudo nano /etc/dhcpcd.conf</code> and paste the following lines of code at the bottom of the file. </p>
                <pre> 
# Define static profile
profile static_eth0
static ip_address=10.0.50.100/24
static routers=10.0.50.1
static domain_name_servers=10.0.50.1

# Fallback to static profile on eth0
interface eth0
fallback static_eth0
                </pre>
                <p> When all else fails, to log on to the Pi, directly connect your computer to the Pi via Ethernet, set your computer's IP address to 10.0.50.101, and <code>ssh pi@10.0.50.100</code> </p>.
              </tab>
              <tab heading="WiFi networks">
                <p> The Pi can easily be pre-configured to connect to multiple WiFi networks.  This feature is useful if the Pi is moved to different locations, each with their own WiFi credentials.  To pre-configure WiFi credentials, from the command line, open the wpa_supplicant.conf file for editing with the command <code>sudo nano /etc/wpa_supplicant/wpa_supplicant.conf</code> and paste the following block of code, once for each network, at the bottom of the file. </p>
                <pre> 
network={
  ssid="ENTER_SSID_HERE"
  psk="ENTER_PASSWORD_HERE"
  key_mgmt=WPA-PSK
}
                </pre>
                <p> Don't forget to enter the SSID and password for each network with much care!  Although networks commonly use a pre-shared key (PSK) for authentication, as specified in the example above, it may be necessary to tweak the settings as discussed in details <a href="https://wiki.archlinux.org/index.php/WPA_supplicant" target="_blank">here</a>. </p>
              </tab>
              <tab heading="More">
                <p> Enable additional features such as data logging by editing <a href="https://github.com/reelyactive/pi-suite/blob/master/pi-suite.js" target="_blank">pi-suite.js</a> with the command <code>nano ~/reelyActive/pi-suite/pi-suite.js</code> or <a href="https://github.com/reelyactive/pi-suite/blob/master/pi-suite-pareto.js" target="_blank">pi-suite-pareto.js</a> with the command <code>nano ~/reelyActive/pi-suite/pi-suite-pareto.js</code>.</p>
                <p> Simply comment or uncomment the desired options by adding or removing two backslashes at the start of each concerned line.  Press Ctrl-X to save the file and exit. </p>
              </tab>
            </tabset>
            <hr>
            <h2> What's next? </h2>
            <p> Our starter kits include a three-month trial of our <a href="http://getpareto.com" target="_blank">Pareto platform</a> which is the easiest way to put your data to good use.  Also, if you build your own unique hub and would like to share your project, <a href="http://www.reelyactive.com/contact/" target="_blank">please get in touch</a>! </p>
            <p class="text-center">
              <a class="btn btn-default" href="make-a-tessel-hub.html"
                 role="button"> Make a Tessel Hub </a>
              <a class="btn btn-success" href="index.html"
                 role="button"> Return to diyActive </a>
            </p>
          </div>
          <div class="col-xs-0 col-sm-1 col-md-2 col-lg-3"></div>
        </div>
      </div>
      <footer class="footer">
        <a href="index.html"> diyActive </a> &nbsp; | &nbsp;
        <a href="http://www.reelyactive.com">
          &copy; reelyActive 2016-2017
        </a>
      </footer>
    </div>
  </body>
</html>
